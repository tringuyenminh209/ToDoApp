// DOL LEAF TodoApp AI - Database Schema (Updated with Implementation Fixes)
// Created for dbdiagram.io visualization
// Version: 1.14
// Updated: 2025-11-16
// Changes:
//   - v1.14: FIXED TO MATCH ACTUAL MIGRATIONS - Added Laravel framework tables (password_reset_tokens, sessions, cache, cache_locks, personal_access_tokens, password_resets)
//   - v1.14: FIXED TO MATCH ACTUAL MIGRATIONS - Restored language/timezone fields in user_settings (migration still has these fields)
//   - v1.14: FIXED TO MATCH ACTUAL MIGRATIONS - Changed tasks.scheduled_time from timestamp to time (per migration 2025_11_15)
//   - v1.13: Schema normalization fixes - removed JSON dependencies, replaced with dedicated tables
//   - v1.13: Added roadmap_milestone_dependencies table (normalized milestone dependencies)
//   - v1.13: Added learning_path_dependencies table (normalized learning path dependencies)
//   - v1.13: Removed tasks.tags JSON field (use normalized tags + task_tags tables)
//   - v1.13: NOTE: language/timezone removal was planned but NOT implemented in migrations yet
//   - v1.13: Removed JSON dependencies from roadmap_milestones (use roadmap_milestone_dependencies table)
//   - v1.13: Removed JSON dependencies from learning_paths (use learning_path_dependencies table)
//   - v1.12: Added Roadmap System (roadmaps, roadmap_milestones, roadmap_templates)
//   - v1.12: Added Task Dependencies System (task_dependencies)
//   - v1.12: Added Task Recurrence System (task_recurrence, task_instances)
//   - v1.12: Added AI Enhancement Tables (ai_roadmap_generations, ai_task_predictions, ai_scheduling_suggestions, ai_dependency_suggestions, ai_optimization_history)
//   - v1.12: Added Time Tracking (time_entries)
//   - v1.12: Added Analytics Tables (user_velocity_metrics, roadmap_critical_paths, burndown_snapshots, estimation_accuracy_logs, productivity_trends)
//   - v1.12: Extended tasks table with roadmap integration, parent_task_id, actual time tracking, completion_percentage, is_recurring, is_template, assigned_to_user_id, is_blocked, story_points
//   - v1.12: Extended projects table with roadmap_id, team_id, project_type, actual dates, time tracking, is_template, visibility, icon, cover_image, is_archived
//   - v1.12: Extended learning_paths table with roadmap_id, prerequisite_skills, difficulty_rating, certification fields, learning_outcomes, resources, completion_criteria, template_id, visibility
//   - v1.11: Added study_schedules table for weekly recurring study schedule (学習スケジュール)
//   - v1.11: Updated user_settings with additional settings (pomodoro_duration, block_notifications, background_sound, push_notifications, daily_reminders, goal_reminders)
//   - v1.11: Updated tasks.learning_milestone_id foreign key to cascade delete
//   - v1.10: Added scheduled_time field to tasks table (予定開始時刻)
//   - v1.9: Added Deep Work & Focus Enhancement tables (focus_environments, distraction_logs, context_switches)
//   - v1.9: Extended tasks table with focus features (requires_deep_focus, allow_interruptions, focus_difficulty, warmup/cooldown/recovery minutes, last_focus_at, total_focus_minutes, distraction_count)
//   - v1.8: Added Chat AI System tables (chat_conversations, chat_messages)
//   - v1.7: Added Cheat Code System tables (cheat_code_languages, cheat_code_sections, code_examples, exercises, exercise_test_cases, user_exercise_submissions, user_code_favorites, user_exercise_progress)
//   - v1.6: Added template tables (learning_path_templates, learning_milestone_templates, task_templates)
//   - v1.6: Fixed data types to match backend (timetable_classes.period, timetable_class_weekly_contents.week_number, timetable_studies.priority)
//   - v1.6: Added missing indexes for timetable_studies
//   - v1.5: Added timetable system (timetable_classes, timetable_studies, timetable_class_weekly_contents)
//   - v1.5: Updated daily_checkins with mood, sleep_hours, stress_level, priorities, goals, notes
//   - v1.5: Updated daily_reviews with mood, individual scores, achievements, challenges, lessons_learned, gratitude, notes
//   - v1.5: Updated tasks with category field
//   - v1.4: Fixed focus_sessions.status enum to include 'active' state
//   - v1.4: Added ai_summaries table for daily/weekly/monthly AI summaries
//   - v1.4: Fixed ai_suggestions field names to match implementation

// ============================================
// Core Tables
// ============================================

Table users {
  id bigint [pk, increment]
  name varchar(255) [not null, note: 'ユーザー名']
  email varchar(255) [unique, not null, note: 'メールアドレス']
  email_verified_at timestamp [null, note: 'メール確認日時']
  password varchar(255) [not null, note: 'パスワード（ハッシュ化）']
  language "ENUM('vi','en','ja')" [not null, default: 'ja', note: 'UI言語']
  timezone varchar(50) [not null, default: 'UTC', note: 'タイムゾーン']
  avatar_url varchar(500) [null, note: 'アバター画像URL']
  remember_token varchar(100) [null]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    email
    created_at
  }
}

// ============================================
// Laravel Framework Tables (Authentication & Cache)
// ============================================

Table password_reset_tokens {
  email varchar(255) [pk, not null, note: 'メールアドレス']
  token varchar(255) [not null, note: 'リセットトークン']
  created_at timestamp [null, note: '作成日時']

  indexes {
    email
  }

  Note: 'Laravel password reset tokens table'
}

Table sessions {
  id varchar(255) [pk, not null, note: 'セッションID']
  user_id bigint [null, note: 'ユーザーID（ログイン時）']
  ip_address varchar(45) [null, note: 'IPアドレス']
  user_agent text [null, note: 'ユーザーエージェント']
  payload longtext [not null, note: 'セッションデータ']
  last_activity integer [not null, note: '最終アクティビティ時刻（UNIX timestamp）']

  indexes {
    user_id
    last_activity
  }

  Note: 'Laravel sessions table'
}

Table cache {
  key varchar(255) [pk, not null, note: 'キャッシュキー']
  value mediumtext [not null, note: 'キャッシュ値']
  expiration integer [not null, note: '有効期限（UNIX timestamp）']

  Note: 'Laravel cache table'
}

Table cache_locks {
  key varchar(255) [pk, not null, note: 'ロックキー']
  owner varchar(255) [not null, note: 'ロック所有者']
  expiration integer [not null, note: '有効期限（UNIX timestamp）']

  Note: 'Laravel cache locks table'
}

Table personal_access_tokens {
  id bigint [pk, increment]
  tokenable_type varchar(255) [not null, note: 'トークン所有者タイプ']
  tokenable_id bigint [not null, note: 'トークン所有者ID']
  name varchar(255) [not null, note: 'トークン名']
  token varchar(64) [unique, not null, note: 'トークン（ハッシュ化）']
  abilities text [null, note: '権限（JSON）']
  last_used_at timestamp [null, note: '最終使用日時']
  expires_at timestamp [null, note: '有効期限']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (tokenable_type, tokenable_id)
    token [unique]
  }

  Note: 'Laravel Sanctum personal access tokens table'
}

Table password_resets {
  email varchar(255) [not null, note: 'メールアドレス']
  token varchar(255) [not null, note: 'リセットトークン']
  created_at timestamp [null, note: '作成日時']

  indexes {
    email
  }

  Note: 'Legacy Laravel password resets table'
}

// ============================================
// User Tables
// ============================================

Table user_profiles {
  id bigint [pk, increment]
  user_id bigint [unique, not null, ref: > users.id]
  goal_type "ENUM('learning','work','health')" [null, note: 'ユーザーの主な目標']
  preferred_time "ENUM('morning','morning_late','afternoon','evening')" [null, note: '好みの作業時間帯']
  notification_enabled boolean [not null, default: true]
  onboarding_completed boolean [not null, default: false]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    user_id [unique]
    onboarding_completed
  }
}

Table user_settings {
  id bigint [pk, increment]
  user_id bigint [unique, not null, ref: > users.id]
  theme "ENUM('light','dark','auto')" [not null, default: 'auto']
  language "ENUM('vi','en','ja')" [not null, default: 'ja', note: 'UI言語（migration still has this field）']
  timezone varchar(50) [not null, default: 'UTC', note: 'タイムゾーン（migration still has this field）']
  default_focus_minutes integer [not null, default: 25, note: 'デフォルトの集中時間（分）']
  pomodoro_duration integer [not null, default: 25, note: 'ポモドーロタイマーの長さ（分）']
  break_minutes integer [not null, default: 5, note: '短い休憩時間（分）']
  long_break_minutes integer [not null, default: 15, note: '長い休憩時間（分）']
  auto_start_break boolean [not null, default: false, note: '休憩を自動的に開始']
  block_notifications boolean [not null, default: true, note: '集中モード中は通知をブロック']
  background_sound boolean [not null, default: false, note: '集中モード中にBGMを再生']
  daily_target_tasks integer [not null, default: 3, note: '1日の目標タスク数']
  notification_enabled boolean [not null, default: true]
  push_notifications boolean [not null, default: true, note: 'プッシュ通知を有効にする']
  daily_reminders boolean [not null, default: true, note: 'デイリーリマインダーを有効にする']
  goal_reminders boolean [not null, default: false, note: 'ゴールリマインダーを有効にする']
  reminder_times json [null, note: 'リマインダー時刻（JSON配列）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    user_id [unique]
  }
}

// ============================================
// Tasks System
// ============================================

Table tags {
  id bigint [pk, increment]
  name varchar(100) [not null, note: 'タグ名']
  color varchar(7) [not null, default: '#0FA968', note: '色（HEX形式）']
  icon varchar(50) [null, note: 'アイコン名']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    name [unique]
  }
}

Table projects {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  roadmap_id bigint [null, ref: > roadmaps.id, note: '親ロードマップID（v1.12）']
  team_id bigint [null, note: 'チームID（将来機能）（v1.12）']
  project_type "ENUM('personal','team','client','learning')" [not null, default: 'personal', note: 'プロジェクトタイプ（v1.12）']
  name_en varchar(255) [not null, note: 'プロジェクト名（英語）']
  name_ja varchar(255) [not null, note: 'プロジェクト名（日本語）']
  description_en text [null, note: '説明（英語）']
  description_ja text [null, note: '説明（日本語）']
  status varchar(50) [not null, default: 'active', note: 'ステータス']
  start_date date [null, note: '開始日']
  actual_start_date date [null, note: '実際の開始日（v1.12）']
  end_date date [null, note: '終了日']
  actual_end_date date [null, note: '実際の終了日（v1.12）']
  progress_percentage decimal(5,2) [default: 0, note: '進捗率']
  estimated_hours integer [not null, default: 0, note: '予想総時間（時間）（v1.12）']
  actual_hours integer [not null, default: 0, note: '実際の時間（時間）（v1.12）']
  color varchar(7) [default: '#6366f1', note: 'カラーコード']
  icon varchar(50) [null, note: 'アイコン（v1.12）']
  cover_image varchar(500) [null, note: 'カバー画像URL（v1.12）']
  is_active boolean [default: true, note: 'アクティブかどうか']
  is_archived boolean [not null, default: false, note: 'アーカイブ済みか（v1.12）']
  archived_at timestamp [null, note: 'アーカイブ日時（v1.12）']
  is_template boolean [not null, default: false, note: 'テンプレートか（v1.12）']
  visibility "ENUM('private','team','public')" [not null, default: 'private', note: '可視性（v1.12）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, is_active)
    (user_id, status)
    roadmap_id [note: 'v1.12']
    project_type [note: 'v1.12']
    (is_archived, is_active) [note: 'v1.12']
  }
}

Table tasks {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  assigned_to_user_id bigint [null, ref: > users.id, note: '割り当てられたユーザーID（v1.12）']
  project_id bigint [null, ref: > projects.id, note: 'プロジェクトID']
  learning_milestone_id bigint [null, ref: > learning_milestones.id, note: '学習マイルストーンID（Learning Path機能）']
  roadmap_id bigint [null, ref: > roadmaps.id, note: 'ロードマップID（v1.12）']
  roadmap_milestone_id bigint [null, ref: > roadmap_milestones.id, note: 'ロードマップマイルストーンID（v1.12）']
  parent_task_id bigint [null, ref: > tasks.id, note: '親タスクID（階層構造）（v1.12）']
  template_id bigint [null, ref: > task_templates.id, note: 'テンプレートID（v1.12）']
  title varchar(255) [not null, note: 'タスクタイトル']
  category "ENUM('study','work','personal','other')" [not null, default: 'other', note: 'タスクカテゴリー（v1.5）']
  description text [null, note: '詳細説明']
  priority tinyint [not null, default: 3, note: '優先度（1-5、5が最高）']
  story_points integer [null, note: 'ストーリーポイント（Agile）（v1.12）']
  energy_level "ENUM('low','medium','high')" [not null, default: 'medium', note: '必要なエネルギーレベル']
  estimated_minutes integer [null, note: '予想時間（分）']
  actual_minutes integer [null, note: '実際の時間（分）（v1.12）']
  deadline timestamp [null, note: '締め切り']
  scheduled_time time [null, note: '予定開始時刻 (タスクを開始する予定の時刻)（v1.10, changed to time in migration 2025_11_15）']
  actual_start_date timestamp [null, note: '実際の開始日時（v1.12）']
  actual_end_date timestamp [null, note: '実際の完了日時（v1.12）']
  status "ENUM('pending','in_progress','completed','cancelled')" [not null, default: 'pending', note: 'タスクステータス']
  completion_percentage "decimal(5,2)" [not null, default: 0, note: '完了率（0-100）（v1.12）']
  is_blocked boolean [not null, default: false, note: 'ブロックされているか（v1.12）']
  blocked_reason text [null, note: 'ブロック理由（v1.12）']
  ai_breakdown_enabled boolean [not null, default: false, note: 'AIによる分解済み']
  is_recurring boolean [not null, default: false, note: '繰り返しタスクか（v1.12）']
  is_template boolean [not null, default: false, note: 'テンプレートか（v1.12）']
  requires_deep_focus boolean [not null, default: false, note: 'Deep Work Modeが必要（v1.9）']
  allow_interruptions boolean [not null, default: true, note: '割り込みを許可するか（v1.9）']
  focus_difficulty integer [not null, default: 3, note: '集中難易度（1-5: shallow to ultra-deep focus）（v1.9）']
  warmup_minutes integer [null, note: 'タスク前の準備時間（分）（v1.9）']
  cooldown_minutes integer [null, note: 'タスク後の振り返り時間（分）（v1.9）']
  recovery_minutes integer [null, note: 'タスク完了後の休息時間（分）（v1.9）']
  last_focus_at timestamp [null, note: '最後にこのタスクに集中した時刻（v1.9）']
  total_focus_minutes integer [not null, default: 0, note: '集中に費やした合計時間（分）（v1.9）']
  distraction_count integer [not null, default: 0, note: '記録された気が散った回数（v1.9）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, status)
    (project_id, status)
    project_id
    deadline
    priority
    (user_id, created_at)
    learning_milestone_id
    (user_id, scheduled_time) [note: 'v1.10: Added index for scheduled_time queries']
    roadmap_id [note: 'v1.12']
    roadmap_milestone_id [note: 'v1.12']
    parent_task_id [note: 'v1.12']
    assigned_to_user_id [note: 'v1.12']
    is_blocked [note: 'v1.12']
    (is_recurring, status) [note: 'v1.12']
    is_template [note: 'v1.12']
  }
}

Table subtasks {
  id bigint [pk, increment]
  task_id bigint [not null, ref: > tasks.id]
  title varchar(255) [not null, note: 'サブタスクタイトル']
  is_completed boolean [not null, default: false, note: '完了済み']
  estimated_minutes integer [null, note: '予想時間（分）']
  sort_order integer [not null, default: 0, note: '並び順']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (task_id, sort_order)
    (task_id, is_completed)
  }
}

Table task_tags {
  id bigint [pk, increment]
  task_id bigint [not null, ref: > tasks.id]
  tag_id bigint [not null, ref: > tags.id]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (task_id, tag_id) [unique]
    tag_id
  }
}

// ============================================
// Focus Sessions & Daily Routine
// ============================================

Table focus_environments {
  id bigint [pk, increment]
  task_id bigint [not null, ref: > tasks.id, note: 'タスクID']
  user_id bigint [not null, ref: > users.id, note: 'ユーザーID']
  focus_session_id bigint [null, ref: > focus_sessions.id, note: 'フォーカスセッションID（v1.9）']
  quiet_space boolean [not null, default: false, note: '静かな空間']
  phone_silent boolean [not null, default: false, note: '電話をサイレント']
  materials_ready boolean [not null, default: false, note: '資料の準備完了']
  water_coffee_ready boolean [not null, default: false, note: '水/コーヒーの準備完了']
  comfortable_position boolean [not null, default: false, note: '快適な姿勢']
  notifications_off boolean [not null, default: false, note: '通知オフ']
  apps_closed json [null, note: '閉じたアプリ/タブのリスト']
  all_checks_passed boolean [not null, default: false, note: 'すべてのチェックが完了']
  notes text [null, note: 'メモ']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    task_id
    user_id
    (user_id, created_at)
  }
}

Table distraction_logs {
  id bigint [pk, increment]
  task_id bigint [not null, ref: > tasks.id, note: 'タスクID']
  user_id bigint [not null, ref: > users.id, note: 'ユーザーID']
  focus_session_id bigint [null, ref: > focus_sessions.id, note: 'フォーカスセッションID（v1.9）']
  distraction_type "ENUM('phone','social_media','noise','person','thoughts','hunger_thirst','fatigue','other')" [not null, default: 'other', note: '気が散ったタイプ']
  duration_seconds integer [null, note: '気が散った時間（秒）']
  notes text [null, note: 'メモ']
  occurred_at timestamp [not null, note: '発生時刻']
  time_of_day time [null, note: '1日のうちの時間']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    task_id
    user_id
    distraction_type
    (user_id, occurred_at)
  }
}

Table context_switches {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id, note: 'ユーザーID']
  from_task_id bigint [null, ref: > tasks.id, note: '元のタスクID（v1.9）']
  from_category varchar(255) [null, note: '元のタスクのカテゴリ']
  from_focus_difficulty integer [null, note: '元のタスクの集中難易度']
  to_task_id bigint [not null, ref: > tasks.id, note: '移動先のタスクID']
  to_category varchar(255) [null, note: '移動先のタスクのカテゴリ']
  to_focus_difficulty integer [null, note: '移動先のタスクの集中難易度']
  is_significant_switch boolean [not null, default: false, note: '重要な切り替え（カテゴリや集中レベルが異なる）']
  estimated_cost_minutes integer [not null, default: 23, note: '推定回復時間（分）']
  user_proceeded boolean [not null, default: false, note: '警告にもかかわらずユーザーが続行したか']
  user_note text [null, note: 'ユーザーのメモ']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    user_id
    (user_id, created_at)
    is_significant_switch
  }
}

Table focus_sessions {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  task_id bigint [not null, ref: > tasks.id]
  session_type "ENUM('work','break','long_break')" [not null, default: 'work', note: 'セッションタイプ：作業、短い休憩、長い休憩']
  duration_minutes integer [not null, note: '予定時間（分）']
  actual_minutes integer [null, note: '実際の時間（分）']
  started_at timestamp [not null, note: '開始時刻']
  ended_at timestamp [null, note: '終了時刻']
  status "ENUM('active','completed','paused','cancelled')" [not null, default: 'active', note: 'セッションステータス（v1.4: added active state）']
  notes text [null, note: 'メモ']
  quality_score tinyint [null, note: '品質スコア（1-5）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, started_at)
    task_id
    (user_id, status)
  }
}

Table daily_checkins {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  date date [not null, note: 'チェックイン日']
  energy_level "ENUM('low','medium','high')" [not null, note: '朝のエネルギーレベル']
  mood_score tinyint [not null, note: '気分スコア（1-5）- 旧形式']
  mood "ENUM('excellent','good','average','poor','terrible')" [null, note: '気分（v1.5）']
  sleep_hours "decimal(4,2)" [null, note: '睡眠時間（v1.5）']
  stress_level "ENUM('low','medium','high')" [null, note: 'ストレスレベル（v1.5）']
  schedule_note text [null, note: '今日のスケジュールメモ - 旧形式']
  priorities json [null, note: '優先事項（JSON配列）（v1.5）']
  goals json [null, note: '目標（JSON配列）（v1.5）']
  notes text [null, note: 'メモ（v1.5）']
  ai_suggestions_generated boolean [not null, default: false, note: 'AI提案生成済み']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, date) [unique]
    date
  }
}

Table daily_reviews {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  date date [not null, note: 'レビュー日']
  mood "ENUM('excellent','good','average','poor','terrible')" [null, note: '気分（v1.5）']
  tasks_completed integer [not null, default: 0, note: '完了したタスク数']
  focus_time_minutes integer [not null, default: 0, note: '合計集中時間（分）']
  productivity_score tinyint [null, note: '生産性スコア（1-10）（v1.5: updated）']
  focus_time_score tinyint [null, note: '集中時間スコア（1-10）（v1.5）']
  task_completion_score tinyint [null, note: 'タスク完了スコア（1-10）（v1.5）']
  goal_achievement_score tinyint [null, note: '目標達成スコア（1-10）（v1.5）']
  work_life_balance_score tinyint [null, note: 'ワークライフバランススコア（1-10）（v1.5）']
  achievements json [null, note: '達成事項（JSON配列）（v1.5）']
  gratitude_note text [null, note: '感謝のメモ - 旧形式']
  gratitude json [null, note: '感謝（JSON配列）（v1.5）']
  challenges_faced text [null, note: '直面した課題 - 旧形式']
  challenges json [null, note: '課題（JSON配列）（v1.5）']
  lessons_learned json [null, note: '学んだこと（JSON配列）（v1.5）']
  tomorrow_goals text [null, note: '明日の目標']
  notes text [null, note: 'メモ（v1.5）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, date) [unique]
    date
  }
}

// ============================================
// Timetable System (v1.5)
// ============================================

Table timetable_classes {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  name varchar(255) [not null, note: '授業名']
  description text [null, note: '説明']
  room varchar(100) [null, note: '教室']
  instructor varchar(255) [null, note: '講師']
  day "ENUM('monday','tuesday','wednesday','thursday','friday','saturday','sunday')" [not null, note: '曜日']
  period integer [not null, note: '時限（1-10）']
  start_time time [not null, note: '開始時刻']
  end_time time [not null, note: '終了時刻']
  color varchar(7) [not null, default: '#4F46E5', note: 'カラーコード']
  icon varchar(50) [null, note: 'アイコン']
  notes text [null, note: 'メモ']
  learning_path_id bigint [null, ref: > learning_paths.id, note: '学習パスID']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, day, period)
    (user_id, created_at)
    learning_path_id
  }
}

Table timetable_class_weekly_contents {
  id bigint [pk, increment]
  timetable_class_id bigint [not null, ref: > timetable_classes.id]
  year integer [not null, note: '年']
  week_number integer [not null, note: '週番号（1-53）']
  week_start_date date [not null, note: '週の開始日（月曜日）']
  title varchar(255) [null, note: '週別タイトル']
  content text [null, note: '週別内容・トピック']
  homework text [null, note: '宿題']
  notes text [null, note: '週別メモ']
  status "ENUM('scheduled','completed','cancelled')" [not null, default: 'scheduled', note: 'ステータス']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (timetable_class_id, year, week_number) [unique, name: 'unique_class_week']
    week_start_date
  }
}

Table timetable_studies {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  timetable_class_id bigint [null, ref: > timetable_classes.id]
  title varchar(255) [not null, note: 'タイトル']
  description text [null, note: '説明']
  type "ENUM('homework','review','exam','project')" [not null, note: 'タイプ']
  subject varchar(255) [null, note: '科目']
  due_date date [null, note: '期限']
  priority integer [not null, default: 3, note: '優先度（1-5）']
  status "ENUM('pending','in_progress','completed')" [not null, default: 'pending', note: 'ステータス']
  completed_at timestamp [null, note: '完了日時']
  task_id bigint [null, ref: > tasks.id, note: '関連タスクID']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, status)
    (user_id, due_date)
    (user_id, type)
    timetable_class_id
    due_date
    task_id
  }
}

// ============================================
// AI Integration
// ============================================

Table ai_suggestions {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  type "ENUM('task_breakdown','daily_plan','smart_schedule','motivational')" [not null, note: '提案タイプ']
  content json [not null, note: '提案内容（JSON形式）']
  source_task_id bigint [null, ref: > tasks.id]
  is_accepted boolean [not null, default: false, note: 'ユーザーが承認済み']
  feedback_score tinyint [null, note: '評価スコア（1-5）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, type)
    source_task_id
    (user_id, created_at)
  }
}

Table ai_summaries {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  summary_type "ENUM('daily','weekly','monthly')" [not null, note: 'サマリータイプ（v1.4: new table）']
  date date [not null, note: 'サマリー日付']
  content json [not null, note: 'AIサマリーコンテンツ（JSON形式）']
  metrics json [null, note: 'メトリクス情報（JSON）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, summary_type)
    (user_id, date)
    (user_id, summary_type, date) [unique]
  }
}

Table ai_interactions {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  interaction_type "ENUM('breakdown','suggestion','coach','reschedule')" [not null, note: 'AI連携タイプ']
  input_data json [not null, note: '入力データ（JSON）']
  response_data json [not null, note: 'レスポンスデータ（JSON）']
  processing_time_ms integer [null, note: '処理時間（ミリ秒）']
  success boolean [not null, default: true, note: '連携成功']
  created_at timestamp [not null]

  indexes {
    (user_id, interaction_type)
    created_at
  }
}

// ============================================
// Chat AI System (v1.8)
// ============================================

Table chat_conversations {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  title varchar(255) [null, note: 'タイトル（最初のメッセージから自動生成）']
  status varchar(255) [not null, default: 'active', note: '会話ステータス（active, archived, deleted）']
  last_message_at timestamp [null, note: '最終メッセージ日時']
  message_count integer [not null, default: 0, note: 'メッセージ数']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    user_id
    (user_id, status)
    (user_id, last_message_at)
  }
}

Table chat_messages {
  id bigint [pk, increment]
  conversation_id bigint [not null, ref: > chat_conversations.id]
  user_id bigint [not null, ref: > users.id]
  role "ENUM('user','assistant','system')" [not null, default: 'user', note: 'メッセージの役割']
  content text [not null, note: 'メッセージ内容']
  metadata json [null, note: 'メタデータ（model, finish_reason等）']
  token_count integer [null, note: '使用トークン数（コスト追跡用）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    conversation_id
    (conversation_id, created_at)
  }
}

// ============================================
// Analytics & Statistics
// ============================================

Table user_stats {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  stat_date date [not null, note: '統計日']
  tasks_completed_today integer [not null, default: 0, note: '今日完了したタスク数']
  focus_minutes_today integer [not null, default: 0, note: '今日の集中時間（分）']
  streak_days integer [not null, default: 0, note: '連続日数']
  productivity_score "decimal(3,2)" [null, note: '生産性スコア']
  mood_average "decimal(3,2)" [null, note: '平均気分']
  energy_avg "ENUM('low','medium','high')" [null, note: '平均エネルギー']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, stat_date) [unique]
    stat_date
  }
}

Table performance_metrics {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  metric_date date [not null, note: 'メトリクス日']
  metric_type "ENUM('daily_completion','focus_time','mood_trend','streak_maintenance')" [not null, note: '指標タイプ']
  metric_value "decimal(10,4)" [not null, note: 'メトリクス値']
  trend_direction "ENUM('up','down','stable')" [null, note: 'トレンド']
  notes text [null, note: 'メモ']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, metric_type, metric_date)
    metric_date
  }
}

// ============================================
// System Tables
// ============================================

Table notifications {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  type "ENUM('reminder','achievement','motivational','system')" [not null, note: '通知タイプ']
  title varchar(255) [not null, note: 'タイトル']
  message text [not null, note: '内容']
  data json [null, note: '追加データ（JSON）']
  is_read boolean [not null, default: false, note: '既読']
  scheduled_at timestamp [null, note: '送信予定時刻']
  sent_at timestamp [null, note: '送信済み時刻']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, is_read)
    scheduled_at
    sent_at
  }
}

Table activity_logs {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  action varchar(100) [not null, note: 'アクション（例: task.created, session.completed）']
  resource_type varchar(50) [null, note: 'リソースタイプ（例: Task, Session）']
  resource_id bigint [null, note: 'リソースID']
  ip_address varchar(45) [null, note: 'IPアドレス']
  user_agent text [null, note: 'ユーザーエージェント']
  metadata json [null, note: '追加メタデータ（JSON）']
  created_at timestamp [not null]

  indexes {
    (user_id, action)
    (resource_type, resource_id)
    created_at
  }
}

// ============================================
// Learning Path System (v1.1)
// ============================================

Table learning_path_templates {
  id bigint [pk, increment]
  title varchar(255) [not null, note: 'テンプレートタイトル']
  description text [null, note: '説明']
  category "ENUM('programming','design','business','language','data_science','other')" [not null, default: 'other', note: 'カテゴリー']
  difficulty "ENUM('beginner','intermediate','advanced')" [not null, default: 'beginner', note: '難易度']
  estimated_hours_total integer [null, note: '総学習時間見積もり（時間）']
  tags json [null, note: 'タグ配列']
  icon varchar(50) [null, note: 'アイコン']
  color varchar(7) [not null, default: '#0FA968', note: '色（HEX）']
  is_featured boolean [not null, default: false, note: 'おすすめテンプレート']
  usage_count integer [not null, default: 0, note: '使用回数']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    category
    difficulty
    (is_featured, usage_count)
  }
}

Table learning_milestone_templates {
  id bigint [pk, increment]
  template_id bigint [not null, ref: > learning_path_templates.id, note: 'テンプレートID']
  title varchar(255) [not null, note: 'マイルストーンタイトル']
  description text [null, note: '説明']
  sort_order integer [not null, default: 0, note: '並び順']
  estimated_hours integer [null, note: '見積もり時間（時間）']
  deliverables json [null, note: '成果物リスト']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (template_id, sort_order)
  }
}

Table task_templates {
  id bigint [pk, increment]
  milestone_template_id bigint [not null, ref: > learning_milestone_templates.id, note: 'マイルストーンテンプレートID']
  title varchar(255) [not null, note: 'タスクタイトル']
  description text [null, note: '説明']
  sort_order integer [not null, default: 0, note: '並び順']
  estimated_minutes integer [null, note: '見積もり時間（分）']
  priority tinyint [not null, default: 3, note: '優先度（1-5）']
  resources json [null, note: 'リソース（リンク、動画など）']
  subtasks json [null, note: 'サブタスクのリスト']
  knowledge_items json [null, note: '学習コンテンツ（ノート、コード例、リンク、演習）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (milestone_template_id, sort_order)
  }
}

Table learning_paths {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  roadmap_id bigint [null, ref: > roadmaps.id, note: '親ロードマップID（統合用）（v1.12）']
  template_id bigint [null, ref: > learning_path_templates.id, note: 'テンプレートID（v1.12）']
  title varchar(255) [not null, note: '学習パスタイトル（例: Java開発者になる）']
  description text [null, note: '詳細説明']
  learning_outcomes json [null, note: '期待される学習成果（v1.12）']
  resources json [null, note: 'リソース（書籍、コース、リンク等）（v1.12）']
  goal_type "ENUM('career','skill','certification','hobby')" [not null, default: 'skill', note: '目標タイプ']
  difficulty_rating tinyint [not null, default: 3, note: '難易度レベル（1-5）（v1.12）']
  certification_available boolean [not null, default: false, note: '認定証が利用可能か（v1.12）']
  certification_name varchar(255) [null, note: '認定証名（v1.12）']
  certification_provider varchar(255) [null, note: '認定証提供者（v1.12）']
  certification_exam_date date [null, note: '認定試験予定日（v1.12）']
  target_start_date date [null, note: '開始予定日']
  target_end_date date [null, note: '終了予定日']
  status "ENUM('active','paused','completed','abandoned')" [not null, default: 'active', note: 'ステータス']
  progress_percentage "decimal(5,2)" [not null, default: 0.00, note: '進捗率（%）']
  completion_criteria json [null, note: '完了基準（v1.12）']
  is_ai_generated boolean [not null, default: false, note: 'AIによって生成されたか']
  ai_prompt text [null, note: 'AI生成時のプロンプト']
  estimated_hours_total integer [null, note: '予想総学習時間']
  actual_hours_total integer [not null, default: 0, note: '実際の総学習時間']
  prerequisite_skills json [null, note: '必要なスキル/知識（v1.12）']
  tags json [null, note: 'タグ（JSON配列）']
  color varchar(7) [not null, default: '#0FA968', note: 'テーマカラー']
  icon varchar(50) [null, note: 'アイコン名']
  visibility "ENUM('private','public','shared')" [not null, default: 'private', note: '可視性（v1.12）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, status)
    (user_id, created_at)
    roadmap_id [note: 'v1.12']
    difficulty_rating [note: 'v1.12']
    certification_available [note: 'v1.12']
    template_id [note: 'v1.12']
  }
}

Table learning_milestones {
  id bigint [pk, increment]
  learning_path_id bigint [not null, ref: > learning_paths.id]
  title varchar(255) [not null, note: 'マイルストーンタイトル（例: 基本文法を習得）']
  description text [null, note: '詳細説明']
  sort_order integer [not null, default: 0, note: '並び順']
  target_start_date date [null, note: '開始予定日']
  target_end_date date [null, note: '終了予定日']
  completed_at timestamp [null, note: '完了日時']
  status "ENUM('pending','in_progress','completed','skipped')" [not null, default: 'pending', note: 'ステータス']
  progress_percentage "decimal(5,2)" [not null, default: 0.00, note: '進捗率（%）']
  estimated_hours integer [null, note: '予想学習時間']
  actual_hours integer [not null, default: 0, note: '実際の学習時間']
  deliverables json [null, note: '成果物リスト（JSON配列）']
  self_assessment tinyint [null, note: '自己評価（1-5）']
  notes text [null, note: 'メモ']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (learning_path_id, sort_order)
    (learning_path_id, status)
  }
}

Table study_schedules {
  id bigint [pk, increment]
  learning_path_id bigint [not null, ref: > learning_paths.id, note: '学習パスID']
  study_time time [not null, note: '学習時刻（例: 19:30:00）']
  day_of_week tinyint [not null, note: '曜日（0=日曜日、1=月曜日、...、6=土曜日）']
  duration_minutes integer [not null, default: 60, note: '学習時間（分）']
  is_active boolean [not null, default: true, note: 'アクティブフラグ']
  reminder_before_minutes integer [not null, default: 30, note: 'リマインダー時間（分前）']
  reminder_enabled boolean [not null, default: true, note: 'リマインダー有効']
  completed_sessions integer [not null, default: 0, note: '完了セッション数']
  missed_sessions integer [not null, default: 0, note: '未実施セッション数']
  last_studied_at date [null, note: '最終学習日']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (learning_path_id, day_of_week)
    (learning_path_id, is_active)
    (learning_path_id, day_of_week, study_time) [unique, note: '学習パス・曜日・時刻のユニーク制約']
  }
}

// ============================================
// Roadmap System (v1.12)
// ============================================

Table roadmaps {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  title varchar(255) [not null, note: 'ロードマップタイトル']
  description text [null, note: '説明']
  vision_statement text [null, note: 'ビジョンステートメント']
  goal_type "ENUM('career','project','skill','business','health','education','personal','other')" [not null, default: 'project', note: '目標タイプ']
  target_start_date date [null, note: '開始予定日']
  target_end_date date [null, note: '終了予定日']
  status "ENUM('planning','active','on_hold','completed','cancelled')" [not null, default: 'planning', note: 'ステータス']
  progress_percentage "decimal(5,2)" [not null, default: 0, note: '進捗率（0-100）']
  is_ai_generated boolean [not null, default: false, note: 'AI生成か']
  ai_prompt text [null, note: 'AI生成時のプロンプト']
  visibility "ENUM('private','team','public')" [not null, default: 'private', note: '可視性']
  color varchar(7) [null, note: 'カラーコード（HEX）']
  icon varchar(50) [null, note: 'アイコン']
  cover_image varchar(500) [null, note: 'カバー画像URL']
  estimated_hours_total integer [not null, default: 0, note: '予想総時間（時間）']
  actual_hours_total integer [not null, default: 0, note: '実際の総時間（時間）']
  priority tinyint [not null, default: 3, note: '優先度（1-5: 1=最低、5=最高）']
  tags json [null, note: 'タグ（JSON配列）']
  metadata json [null, note: 'メタデータ（JSON）']
  created_at timestamp [not null]
  updated_at timestamp [not null]
  deleted_at timestamp [null, note: 'ソフトデリート']

  indexes {
    (user_id, status)
    (user_id, goal_type)
    target_end_date
    priority
  }
}

Table roadmap_milestones {
  id bigint [pk, increment]
  roadmap_id bigint [not null, ref: > roadmaps.id]
  parent_milestone_id bigint [null, ref: > roadmap_milestones.id, note: '親マイルストーンID（階層構造）']
  title varchar(255) [not null, note: 'マイルストーンタイトル']
  description text [null, note: '説明']
  milestone_type "ENUM('phase','sprint','quarter','month','week','custom')" [not null, default: 'phase', note: 'マイルストーンタイプ']
  order_index integer [not null, default: 0, note: '並び順']
  level tinyint [not null, default: 0, note: '階層レベル（0=トップ、1=サブ、2=サブサブ）']
  status "ENUM('not_started','in_progress','completed','blocked','cancelled')" [not null, default: 'not_started', note: 'ステータス']
  progress_percentage "decimal(5,2)" [not null, default: 0, note: '進捗率（0-100）']
  start_date date [null, note: '開始日']
  due_date date [null, note: '期限日']
  completed_at timestamp [null, note: '完了日時']
  estimated_hours integer [not null, default: 0, note: '予想時間（時間）']
  actual_hours integer [not null, default: 0, note: '実際の時間（時間）']
  is_critical_path boolean [not null, default: false, note: 'クリティカルパスか']
  slack_time_days integer [not null, default: 0, note: 'フロート時間（日）']
  deliverables json [null, note: '成果物リスト']
  success_criteria json [null, note: '成功基準']
  notes text [null, note: 'メモ']
  resources json [null, note: 'リソース']
  created_at timestamp [not null]
  updated_at timestamp [not null]
  deleted_at timestamp [null, note: 'ソフトデリート']

  indexes {
    (roadmap_id, order_index)
    (roadmap_id, status)
    parent_milestone_id
    due_date
    is_critical_path
  }
}

Table roadmap_templates {
  id bigint [pk, increment]
  created_by_user_id bigint [null, ref: > users.id, note: '作成者ID']
  title varchar(255) [not null, note: 'テンプレートタイトル']
  description text [not null, note: '説明']
  category varchar(100) [null, note: 'カテゴリ']
  goal_type "ENUM('career','project','skill','business','health','education','personal','other')" [not null, default: 'skill', note: '目標タイプ']
  difficulty "ENUM('beginner','intermediate','advanced','expert')" [not null, default: 'intermediate', note: '難易度']
  estimated_weeks integer [not null, default: 0, note: '予想週数']
  estimated_hours integer [not null, default: 0, note: '予想時間（時間）']
  template_data json [not null, note: 'ロードマップ構造（マイルストーン、タスク、依存関係を含む）']
  tags json [null, note: 'タグ（JSON配列）']
  prerequisites json [null, note: '前提条件']
  learning_outcomes json [null, note: '学習成果']
  is_featured boolean [not null, default: false, note: 'おすすめテンプレート']
  is_public boolean [not null, default: true, note: '公開フラグ']
  popularity_score integer [not null, default: 0, note: '人気スコア']
  usage_count integer [not null, default: 0, note: '使用回数']
  icon varchar(50) [null, note: 'アイコン']
  color varchar(7) [null, note: 'カラーコード']
  thumbnail varchar(500) [null, note: 'サムネイルURL']
  created_at timestamp [not null]
  updated_at timestamp [not null]
  deleted_at timestamp [null, note: 'ソフトデリート']

  indexes {
    category
    difficulty
    (is_featured, popularity_score)
    is_public
  }
}

// ============================================
// Task Dependencies & Recurrence (v1.12)
// ============================================

Table task_dependencies {
  id bigint [pk, increment]
  task_id bigint [not null, ref: > tasks.id]
  depends_on_task_id bigint [not null, ref: > tasks.id, note: '依存するタスクID']
  dependency_type "ENUM('finish_to_start','start_to_start','finish_to_finish','start_to_finish')" [not null, default: 'finish_to_start', note: '依存関係タイプ（FS=Finish-to-Start、SS=Start-to-Start、FF=Finish-to-Finish、SF=Start-to-Finish）']
  lag_days integer [not null, default: 0, note: 'ラグ/リード時間（日、負の値=リード時間）']
  is_hard_dependency boolean [not null, default: true, note: 'ハード依存関係か（true=ブロッキング、false=ソフト提案）']
  reason varchar(255) [null, note: '理由']
  metadata json [null, note: 'メタデータ']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    task_id
    depends_on_task_id
    (task_id, dependency_type)
    (task_id, depends_on_task_id) [unique, note: '重複依存関係を防止']
  }
}

Table task_recurrence {
  id bigint [pk, increment]
  task_id bigint [not null, ref: > tasks.id]
  recurrence_type "ENUM('daily','weekly','monthly','yearly','custom')" [not null, default: 'daily', note: '繰り返しタイプ']
  interval integer [not null, default: 1, note: '間隔（N日/週/月/年ごと）']
  days_of_week json [null, note: '週パターン（配列: [0,1,2,3,4,5,6] 0=日曜日）']
  day_of_month tinyint [null, note: '月の日（1-31）']
  monthly_pattern "ENUM('day_of_month','nth_weekday')" [null, note: '月パターン']
  nth_occurrence tinyint [null, note: 'N回目の出現（1st, 2nd, 3rd, 4th, last）']
  weekday tinyint [null, note: '曜日（0-6: 日曜日-土曜日）']
  month_of_year tinyint [null, note: '年の月（1-12）']
  recurrence_end_type "ENUM('never','after_count','by_date')" [not null, default: 'never', note: '繰り返し終了タイプ']
  recurrence_end_count integer [null, note: 'N回後に終了']
  recurrence_end_date date [null, note: '終了日']
  last_generated_at timestamp [null, note: '最後に生成された日時']
  next_occurrence_date date [null, note: '次の発生予定日']
  total_instances_generated integer [not null, default: 0, note: '生成されたインスタンス総数']
  is_active boolean [not null, default: true, note: 'アクティブフラグ']
  create_in_advance boolean [not null, default: true, note: '期限前にインスタンスを作成']
  advance_days integer [not null, default: 1, note: '何日前に作成するか']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    task_id
    next_occurrence_date
    is_active
  }
}

Table task_instances {
  id bigint [pk, increment]
  task_recurrence_id bigint [not null, ref: > task_recurrence.id]
  task_id bigint [not null, ref: > tasks.id]
  scheduled_date date [not null, note: '予定日']
  completed_at timestamp [null, note: '完了日時']
  status "ENUM('pending','completed','skipped','cancelled')" [not null, default: 'pending', note: 'ステータス']
  is_skipped boolean [not null, default: false, note: 'スキップされたか']
  skip_reason varchar(255) [null, note: 'スキップ理由']
  overrides json [null, note: 'このインスタンス用のカスタムタイトル、説明、時間等']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (task_recurrence_id, scheduled_date)
    (task_id, status)
    scheduled_date
  }
}

// ============================================
// Roadmap Milestone Dependencies (v1.13)
// ============================================

Table roadmap_milestone_dependencies {
  id bigint [pk, increment]
  milestone_id bigint [not null, ref: > roadmap_milestones.id, note: 'マイルストーンID']
  depends_on_milestone_id bigint [not null, ref: > roadmap_milestones.id, note: '依存するマイルストーンID']
  dependency_type "ENUM('finish_to_start','start_to_start','finish_to_finish','start_to_finish')" [not null, default: 'finish_to_start', note: '依存関係タイプ（FS=Finish-to-Start、SS=Start-to-Start、FF=Finish-to-Finish、SF=Start-to-Finish）']
  lag_days integer [not null, default: 0, note: 'ラグ/リード時間（日、負の値=リード時間）']
  is_hard_dependency boolean [not null, default: true, note: 'ハード依存関係か（true=ブロッキング、false=ソフト提案）']
  reason varchar(255) [null, note: '理由']
  metadata json [null, note: 'メタデータ']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    milestone_id
    depends_on_milestone_id
    (milestone_id, dependency_type)
    (milestone_id, depends_on_milestone_id) [unique, note: '重複依存関係を防止']
  }
}

// ============================================
// Learning Path Dependencies (v1.13)
// ============================================

Table learning_path_dependencies {
  id bigint [pk, increment]
  learning_path_id bigint [not null, ref: > learning_paths.id, note: '学習パスID']
  depends_on_path_id bigint [not null, ref: > learning_paths.id, note: '依存する学習パスID']
  dependency_strength "ENUM('required','recommended','optional')" [not null, default: 'required', note: '依存関係の強度（required=必須、recommended=推奨、optional=任意）']
  min_completion_percentage tinyint [not null, default: 100, note: '最小完了率（0-100: 前提条件が完了する必要がある最小%）']
  reason text [null, note: '理由/メモ']
  metadata json [null, note: 'メタデータ']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    learning_path_id
    depends_on_path_id
    dependency_strength
    (learning_path_id, depends_on_path_id) [unique, note: '重複依存関係を防止']
  }
}

// ============================================
// AI Enhancement System (v1.12)
// ============================================

Table ai_roadmap_generations {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  roadmap_id bigint [null, ref: > roadmaps.id, note: '生成されたロードマップID']
  prompt text [not null, note: 'プロンプト']
  goal_description text [not null, note: '目標説明']
  context_data json [null, note: 'コンテキストデータ（スキル、経験、タイムライン、好み）']
  generated_structure json [not null, note: 'AI生成ロードマップ構造']
  generation_model varchar(50) [not null, default: 'gpt-4', note: '生成モデル']
  tokens_used integer [not null, default: 0, note: '使用トークン数']
  generation_time_seconds float [not null, default: 0, note: '生成時間（秒）']
  status "ENUM('success','partial','failed')" [not null, default: 'success', note: 'ステータス']
  error_message text [null, note: 'エラーメッセージ']
  user_rating tinyint [null, note: 'ユーザー評価（1-5）']
  user_feedback text [null, note: 'ユーザーフィードバック']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, created_at)
    roadmap_id
  }
}

Table ai_task_predictions {
  id bigint [pk, increment]
  task_id bigint [not null, ref: > tasks.id]
  predicted_duration_minutes integer [null, note: '予測時間（分）']
  predicted_completion_date timestamp [null, note: '予測完了日']
  confidence_score "decimal(5,2)" [not null, default: 0, note: '信頼度スコア（0-100）']
  factors_considered json [null, note: '考慮された要因（優先度、複雑さ、履歴、ユーザーベロシティ）']
  reasoning text [null, note: '推論']
  actual_duration_minutes integer [null, note: '実際の時間（分）（タスク完了時に記入）']
  actual_completion_date timestamp [null, note: '実際の完了日']
  prediction_accuracy_score "decimal(5,2)" [null, note: '予測精度スコア（0-100）']
  duration_error_minutes integer [null, note: '時間誤差（分）（実際 - 予測）']
  date_error_days integer [null, note: '日付誤差（日）']
  prediction_model varchar(50) [not null, default: 'gpt-4', note: '予測モデル']
  predicted_at timestamp [not null, note: '予測日時']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    task_id
    predicted_at
    prediction_accuracy_score
  }
}

Table ai_scheduling_suggestions {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  task_id bigint [not null, ref: > tasks.id]
  suggested_start_time timestamp [not null, note: '提案開始時刻']
  suggested_duration_minutes integer [not null, note: '提案時間（分）']
  suggested_date date [not null, note: '提案日']
  reasoning text [not null, note: '推論']
  factors json [null, note: '要因（エネルギーレベル、カレンダー適合、依存関係）']
  energy_level_match "decimal(5,2)" [not null, default: 0, note: 'エネルギーレベル一致度（0-100）']
  calendar_fit_score "decimal(5,2)" [not null, default: 0, note: 'カレンダー適合スコア（0-100）']
  overall_score "decimal(5,2)" [not null, default: 0, note: '総合スコア（0-100）']
  is_accepted boolean [null, note: '承認されたか']
  user_feedback text [null, note: 'ユーザーフィードバック']
  accepted_at timestamp [null, note: '承認日時']
  rejected_at timestamp [null, note: '拒否日時']
  alternatives json [null, note: '代替提案（他の時間枠）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, suggested_date)
    (task_id, is_accepted)
    overall_score
  }
}

Table ai_dependency_suggestions {
  id bigint [pk, increment]
  roadmap_id bigint [null, ref: > roadmaps.id]
  task_id bigint [not null, ref: > tasks.id]
  suggested_dependency_task_id bigint [not null, ref: > tasks.id, note: '提案された依存タスクID']
  suggested_dependency_type "ENUM('finish_to_start','start_to_start','finish_to_finish','start_to_finish')" [not null, default: 'finish_to_start', note: '提案された依存関係タイプ']
  reasoning text [not null, note: 'AI推論']
  confidence_score "decimal(5,2)" [not null, default: 0, note: '信頼度スコア（0-100）']
  is_accepted boolean [null, note: '承認されたか']
  accepted_at timestamp [null, note: '承認日時']
  rejected_at timestamp [null, note: '拒否日時']
  rejection_reason text [null, note: '拒否理由']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (task_id, is_accepted)
    roadmap_id
    confidence_score
  }
}

Table ai_optimization_history {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  roadmap_id bigint [null, ref: > roadmaps.id]
  optimization_type "ENUM('task_order','schedule','dependencies','time_allocation','priority_adjustment')" [not null, note: '最適化タイプ']
  before_state json [not null, note: '最適化前の状態']
  after_state json [not null, note: '最適化後の状態']
  changes_made json [not null, note: '行われた変更']
  reasoning text [not null, note: '推論']
  improvement_score "decimal(5,2)" [null, note: '改善スコア（0-100）']
  metrics json [null, note: 'メトリクス']
  was_applied boolean [not null, default: false, note: '適用されたか']
  user_rating tinyint [null, note: 'ユーザー評価（1-5）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, optimization_type)
    roadmap_id
  }
}

// ============================================
// Time Tracking (v1.12)
// ============================================

Table time_entries {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  task_id bigint [null, ref: > tasks.id]
  project_id bigint [null, ref: > projects.id]
  roadmap_id bigint [null, ref: > roadmaps.id]
  description text [null, note: '説明']
  started_at timestamp [not null, note: '開始時刻']
  ended_at timestamp [null, note: '終了時刻']
  duration_minutes integer [null, note: '時間（分）（終了時に自動計算）']
  is_manual boolean [not null, default: false, note: '手動入力か（手動入力 vs タイマーベース）']
  is_billable boolean [not null, default: false, note: '請求可能か（フリーランサー/契約者用）']
  hourly_rate "decimal(10,2)" [null, note: '時給']
  total_amount "decimal(10,2)" [null, note: '総額（自動計算）']
  currency varchar(3) [not null, default: 'USD', note: '通貨']
  tags json [null, note: 'タグ']
  entry_type "ENUM('work','meeting','break','research','learning','planning','review','other')" [not null, default: 'work', note: 'エントリータイプ']
  productivity_rating tinyint [null, note: '生産性評価（1-5）']
  notes text [null, note: 'メモ']
  metadata json [null, note: 'メタデータ']
  location varchar(255) [null, note: '場所（オプション追跡）']
  device varchar(100) [null, note: 'デバイス（オプション追跡）']
  external_id varchar(255) [null, note: '外部ID（外部ツールとの同期用）']
  external_source varchar(100) [null, note: '外部ソース']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, started_at)
    (task_id, started_at)
    (project_id, started_at)
    (roadmap_id, started_at)
    is_billable
    (started_at, ended_at)
  }
}

// ============================================
// Analytics & Metrics (v1.12)
// ============================================

Table user_velocity_metrics {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  week_start_date date [not null, note: '週開始日']
  week_end_date date [not null, note: '週終了日']
  week_number tinyint [not null, note: '週番号']
  year integer [not null, note: '年']
  tasks_completed integer [not null, default: 0, note: '完了タスク数']
  tasks_started integer [not null, default: 0, note: '開始タスク数']
  tasks_cancelled integer [not null, default: 0, note: 'キャンセルタスク数']
  story_points_completed integer [not null, default: 0, note: '完了ストーリーポイント（Agile用）']
  story_points_planned integer [not null, default: 0, note: '計画ストーリーポイント']
  estimated_hours integer [not null, default: 0, note: '予想時間（時間）']
  actual_hours integer [not null, default: 0, note: '実際の時間（時間）']
  focus_hours integer [not null, default: 0, note: '集中時間（時間）']
  velocity_score "decimal(8,2)" [not null, default: 0, note: 'ベロシティスコア（週あたりタスク数）']
  story_points_velocity "decimal(8,2)" [not null, default: 0, note: 'ストーリーポイントベロシティ']
  estimation_accuracy "decimal(5,2)" [not null, default: 0, note: '見積もり精度（0-100）']
  total_error_minutes integer [not null, default: 0, note: '総誤差（分）（実際 - 予想の合計）']
  productivity_score "decimal(5,2)" [not null, default: 0, note: '生産性スコア（0-100）']
  completion_rate "decimal(5,2)" [not null, default: 0, note: '完了率（計画タスクの完了%）']
  distractions_count integer [not null, default: 0, note: '気が散った回数']
  context_switches_count integer [not null, default: 0, note: 'コンテキスト切り替え回数']
  average_task_duration_hours "decimal(8,2)" [not null, default: 0, note: '平均タスク時間（時間）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, week_start_date)
    (user_id, year, week_number)
    (user_id, week_start_date) [unique]
  }
}

Table roadmap_critical_paths {
  id bigint [pk, increment]
  roadmap_id bigint [not null, ref: > roadmaps.id]
  critical_path_tasks json [not null, note: 'クリティカルパスタスク（順序付きタスクID配列）']
  critical_path_milestones json [null, note: 'クリティカルパスマイルストーン（マイルストーンID配列）']
  total_duration_days integer [not null, note: '総期間（日）']
  total_duration_hours integer [not null, note: '総期間（時間）']
  earliest_start_date date [null, note: '最早開始日']
  earliest_finish_date date [null, note: '最早終了日']
  total_slack_days integer [not null, default: 0, note: '総フロート/スラック時間（日）']
  bottleneck_tasks json [null, note: 'ボトルネックタスク（スラック時間なしのタスク）']
  high_risk_tasks json [null, note: '高リスクタスク']
  calculated_at timestamp [not null, note: '計算日時']
  calculation_method varchar(100) [not null, default: 'critical_path_method', note: '計算方法']
  is_current boolean [not null, default: true, note: '現在の計算か']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (roadmap_id, is_current)
    calculated_at
  }
}

Table burndown_snapshots {
  id bigint [pk, increment]
  roadmap_id bigint [null, ref: > roadmaps.id]
  project_id bigint [null, ref: > projects.id]
  snapshot_date date [not null, note: 'スナップショット日']
  remaining_tasks integer [not null, note: '残りタスク数']
  remaining_hours integer [not null, note: '残り時間（時間）']
  remaining_story_points integer [not null, default: 0, note: '残りストーリーポイント']
  ideal_remaining_hours integer [not null, note: '理想的な残り時間（時間）']
  ideal_remaining_tasks integer [not null, note: '理想的な残りタスク数']
  completed_tasks_today integer [not null, default: 0, note: '今日完了したタスク数']
  completed_hours_today integer [not null, default: 0, note: '今日完了した時間（時間）']
  total_tasks integer [not null, note: '総タスク数']
  total_hours integer [not null, note: '総時間（時間）']
  progress_percentage "decimal(5,2)" [not null, default: 0, note: '進捗率（%）']
  current_velocity "decimal(8,2)" [null, note: '現在のベロシティ']
  projected_completion_date date [null, note: '予測完了日']
  days_ahead_behind integer [not null, default: 0, note: 'スケジュールより前/後（日）（負の値=遅れ）']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (roadmap_id, snapshot_date)
    (project_id, snapshot_date)
    (roadmap_id, snapshot_date) [unique]
  }
}

Table estimation_accuracy_logs {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  task_id bigint [not null, ref: > tasks.id]
  estimated_minutes integer [not null, note: '予想時間（分）']
  actual_minutes integer [not null, note: '実際の時間（分）']
  difference_minutes integer [not null, note: '差（分）']
  accuracy_percentage "decimal(5,2)" [not null, note: '精度（0-100）']
  estimation_quality "ENUM('excellent','good','fair','poor')" [not null, note: '見積もり品質（excellent=<10%誤差、good=10-25%、fair=25-50%、poor=>50%）']
  task_category varchar(100) [null, note: 'タスクカテゴリ']
  task_priority tinyint [null, note: 'タスク優先度']
  task_complexity tinyint [null, note: 'タスク複雑さ']
  was_ai_estimated boolean [not null, default: false, note: 'AI見積もりか']
  completed_at timestamp [not null, note: '完了日時']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, completed_at)
    estimation_quality
    task_category
  }
}

Table productivity_trends {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  trend_date date [not null, note: 'トレンド日']
  period_type "ENUM('daily','weekly','monthly')" [not null, default: 'daily', note: '期間タイプ']
  productivity_score "decimal(5,2)" [not null, default: 0, note: '生産性スコア（0-100）']
  focused_hours integer [not null, default: 0, note: '集中時間（時間）']
  tasks_completed integer [not null, default: 0, note: '完了タスク数']
  completion_rate "decimal(5,2)" [not null, default: 0, note: '完了率']
  peak_productivity_hours json [null, note: 'ピーク生産性時間（1日のうち最も生産性の高い時間）']
  best_day_of_week varchar(20) [null, note: '最良の曜日']
  average_mood "decimal(3,1)" [null, note: '平均気分（1-5）']
  average_energy_level varchar(20) [null, note: '平均エネルギーレベル']
  blockers_encountered integer [not null, default: 0, note: '遭遇したブロッカー数']
  distractions_count integer [not null, default: 0, note: '気が散った回数']
  top_distractions json [null, note: '主な気が散った要因']
  insights json [null, note: 'インサイト']
  recommendations json [null, note: '推奨事項']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, trend_date)
    (user_id, period_type)
  }
}

// ============================================
// Knowledge Repository (v1.1)
// ============================================

Table knowledge_categories {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  parent_id bigint [null, ref: > knowledge_categories.id, note: '親カテゴリID（階層構造）']
  name varchar(255) [not null, note: 'カテゴリ名（例: IT > Java > OOP）']
  description text [null, note: '説明']
  sort_order integer [not null, default: 0, note: '並び順']
  color varchar(7) [not null, default: '#0FA968', note: 'テーマカラー']
  icon varchar(50) [null, note: 'アイコン名']
  item_count integer [not null, default: 0, note: 'このカテゴリ内のアイテム数']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, parent_id)
    (user_id, name)
  }
}

Table knowledge_items {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  category_id bigint [not null, ref: > knowledge_categories.id]
  title varchar(500) [not null, note: 'タイトル']
  item_type "ENUM('note','code_snippet','resource_link','exercise','attachment')" [not null, default: 'note', note: 'アイテムタイプ']
  content longtext [null, note: 'コンテンツ（Markdown対応）']
  code_language varchar(50) [null, note: 'コード言語（例: java, python）']
  url varchar(2048) [null, note: 'リソースURL']
  question text [null, note: '演習問題の問題文']
  answer text [null, note: '演習問題の解答']
  difficulty "ENUM('easy','medium','hard')" [null, note: '難易度']
  attachment_path varchar(500) [null, note: '添付ファイルパス']
  attachment_mime varchar(100) [null, note: '添付ファイルMIMEタイプ']
  attachment_size integer [null, note: '添付ファイルサイズ（バイト）']
  tags json [null, note: 'タグ（JSON配列）']
  learning_path_id bigint [null, ref: > learning_paths.id, note: '関連する学習パス']
  source_task_id bigint [null, ref: > tasks.id, note: '元のタスクID']
  review_count integer [not null, default: 0, note: '復習回数']
  last_reviewed_at timestamp [null, note: '最終復習日時']
  next_review_date date [null, note: '次回復習予定日（間隔反復）']
  retention_score tinyint [not null, default: 3, note: '記憶定着度（1-5）']
  ai_summary text [null, note: 'AI生成の要約']
  view_count integer [not null, default: 0, note: '閲覧回数']
  is_favorite boolean [not null, default: false, note: 'お気に入り']
  is_archived boolean [not null, default: false, note: 'アーカイブ済み']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, category_id)
    (user_id, item_type)
    (user_id, is_favorite)
    learning_path_id
    source_task_id
    next_review_date
    (user_id, created_at)
  }
}

Table knowledge_item_tags {
  id bigint [pk, increment]
  knowledge_item_id bigint [not null, ref: > knowledge_items.id]
  tag_name varchar(100) [not null, note: 'タグ名']
  created_at timestamp [null]

  indexes {
    (knowledge_item_id, tag_name) [unique]
    tag_name
  }
}

// ============================================
// Cheat Code System (v1.7)
// ============================================

Table cheat_code_languages {
  id bigint [pk, increment]
  name varchar(100) [unique, not null, note: '言語名（php, java, python）']
  display_name varchar(100) [not null, note: '表示名（PHP, Java, Python）']
  slug varchar(100) [unique, not null, note: 'URL slug']
  icon varchar(255) [null, note: 'アイコンURL']
  color varchar(20) [not null, default: '#000000', note: '色（HEX）']
  description text [null, note: '説明']
  popularity integer [not null, default: 0, note: '人気度（0-100）']
  category varchar(50) [not null, default: 'programming', note: 'カテゴリ（programming, markup, database）']
  sections_count integer [not null, default: 0, note: 'セクション数']
  examples_count integer [not null, default: 0, note: 'コード例数']
  exercises_count integer [not null, default: 0, note: '演習問題数']
  is_active boolean [not null, default: true, note: '表示フラグ']
  sort_order integer [not null, default: 0, note: '並び順']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    name [unique]
    slug [unique]
    category
    is_active
    popularity
  }
}

Table cheat_code_sections {
  id bigint [pk, increment]
  language_id bigint [not null, ref: > cheat_code_languages.id]
  title varchar(200) [not null, note: 'タイトル（Getting Started, Variables）']
  slug varchar(200) [not null, note: 'URL slug']
  description text [null, note: '説明']
  icon varchar(255) [null, note: 'アイコン']
  examples_count integer [not null, default: 0, note: 'コード例数']
  sort_order integer [not null, default: 0, note: '並び順']
  is_published boolean [not null, default: true, note: '公開フラグ']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (language_id, slug) [unique]
    language_id
    is_published
  }
}

Table code_examples {
  id bigint [pk, increment]
  section_id bigint [not null, ref: > cheat_code_sections.id]
  language_id bigint [not null, ref: > cheat_code_languages.id, note: '言語ID（非正規化）']
  title varchar(200) [not null, note: 'タイトル（hello.php）']
  slug varchar(200) [not null, note: 'URL slug']
  code text [not null, note: 'ソースコード']
  description text [null, note: '説明']
  output text [null, note: '実行結果']
  difficulty "ENUM('easy','medium','hard')" [not null, default: 'easy', note: '難易度']
  tags json [null, note: 'タグ配列']
  views_count integer [not null, default: 0, note: '閲覧回数']
  favorites_count integer [not null, default: 0, note: 'お気に入り数']
  sort_order integer [not null, default: 0, note: '並び順']
  is_published boolean [not null, default: true, note: '公開フラグ']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    section_id
    language_id
    difficulty
    views_count
    (title, description, code) [type: fulltext]
  }
}

Table exercises {
  id bigint [pk, increment]
  language_id bigint [not null, ref: > cheat_code_languages.id]
  title varchar(200) [not null, note: 'タイトル']
  slug varchar(200) [not null, note: 'URL slug']
  description text [not null, note: '説明']
  question text [not null, note: '問題文']
  starter_code text [null, note: 'スターターコード']
  solution text [null, note: '解答（非表示）']
  hints json [null, note: 'ヒント配列']
  difficulty "ENUM('easy','medium','hard')" [not null, default: 'medium', note: '難易度']
  points integer [not null, default: 10, note: 'ポイント']
  tags json [null, note: 'タグ配列']
  time_limit integer [not null, default: 60, note: '時間制限（分）']
  submissions_count integer [not null, default: 0, note: '提出回数']
  success_count integer [not null, default: 0, note: '成功回数']
  success_rate "decimal(5,2)" [not null, default: 0.00, note: '成功率（%）']
  is_published boolean [not null, default: true, note: '公開フラグ']
  sort_order integer [not null, default: 0, note: '並び順']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (language_id, slug) [unique]
    language_id
    difficulty
    success_rate
  }
}

Table exercise_test_cases {
  id bigint [pk, increment]
  exercise_id bigint [not null, ref: > exercises.id]
  input text [not null, note: '入力']
  expected_output text [not null, note: '期待される出力']
  description varchar(255) [null, note: '説明']
  is_sample boolean [not null, default: false, note: 'サンプル表示フラグ']
  is_hidden boolean [not null, default: false, note: '非表示フラグ']
  sort_order integer [not null, default: 0, note: '並び順']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    exercise_id
  }
}

Table user_exercise_submissions {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  exercise_id bigint [not null, ref: > exercises.id]
  code text [not null, note: '提出コード']
  language varchar(50) [not null, note: '言語']
  status "ENUM('pending','running','success','failed','error','timeout')" [not null, default: 'pending', note: 'ステータス']
  passed_test_cases integer [not null, default: 0, note: '通過テストケース数']
  total_test_cases integer [not null, default: 0, note: '総テストケース数']
  score integer [not null, default: 0, note: 'スコア']
  execution_time integer [null, note: '実行時間（ミリ秒）']
  memory_used integer [null, note: '使用メモリ（KB）']
  error_message text [null, note: 'エラーメッセージ']
  test_results json [null, note: 'テスト結果詳細']
  submitted_at timestamp [not null, note: '提出日時']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    user_id
    exercise_id
    status
    submitted_at
  }
}

Table user_code_favorites {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  code_example_id bigint [not null, ref: > code_examples.id]
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, code_example_id) [unique]
  }
}

Table user_exercise_progress {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  exercise_id bigint [not null, ref: > exercises.id]
  is_completed boolean [not null, default: false, note: '完了フラグ']
  best_score integer [not null, default: 0, note: '最高スコア']
  attempts_count integer [not null, default: 0, note: '試行回数']
  last_attempted_at timestamp [null, note: '最終試行日時']
  completed_at timestamp [null, note: '完了日時']
  created_at timestamp [not null]
  updated_at timestamp [not null]

  indexes {
    (user_id, exercise_id) [unique]
    (user_id, is_completed)
  }
}

// ============================================
// Relationships Summary
// ============================================

// User Relationships:
// users (1) → (∞) user_profiles
// users (1) → (∞) user_settings
// users (1) → (∞) projects
// users (1) → (∞) tasks
// users (1) → (∞) tasks (assigned_to_user_id) (v1.12: task assignment)
// users (1) → (∞) focus_sessions
// users (1) → (∞) daily_checkins
// users (1) → (∞) daily_reviews
// users (1) → (∞) ai_suggestions
// users (1) → (∞) ai_summaries (v1.4: new)
// users (1) → (∞) ai_interactions
// users (1) → (∞) user_stats
// users (1) → (∞) performance_metrics
// users (1) → (∞) notifications
// users (1) → (∞) activity_logs
// users (1) → (∞) learning_paths
// users (1) → (∞) knowledge_categories
// users (1) → (∞) knowledge_items
// users (1) → (∞) timetable_classes (v1.5: new)
// users (1) → (∞) timetable_studies (v1.5: new)
// users (1) → (∞) user_exercise_submissions (v1.7: new)
// users (1) → (∞) user_code_favorites (v1.7: new)
// users (1) → (∞) user_exercise_progress (v1.7: new)
// users (1) → (∞) focus_environments (v1.9: new)
// users (1) → (∞) distraction_logs (v1.9: new)
// users (1) → (∞) context_switches (v1.9: new)
// users (1) → (∞) roadmaps (v1.12: new)
// users (1) → (∞) roadmap_templates (created_by_user_id) (v1.12: new)
// users (1) → (∞) ai_roadmap_generations (v1.12: new)
// users (1) → (∞) ai_scheduling_suggestions (v1.12: new)
// users (1) → (∞) ai_optimization_history (v1.12: new)
// users (1) → (∞) time_entries (v1.12: new)
// users (1) → (∞) user_velocity_metrics (v1.12: new)
// users (1) → (∞) estimation_accuracy_logs (v1.12: new)
// users (1) → (∞) productivity_trends (v1.12: new)

// Project Relationships:
// projects (1) → (∞) tasks
// projects (∞) → (1) roadmaps (v1.12: new)
// projects (1) → (∞) time_entries (v1.12: new)
// projects (1) → (∞) burndown_snapshots (v1.12: new)

// Task Relationships:
// tasks (1) → (∞) subtasks
// tasks (∞) ← → (∞) tags (via task_tags)
// tasks (1) → (∞) focus_sessions
// tasks (1) → (∞) ai_suggestions (optional)
// tasks (∞) → (1) learning_milestones (optional)
// tasks (∞) → (1) projects (optional)
// tasks (∞) → (1) roadmaps (v1.12: new)
// tasks (∞) → (1) roadmap_milestones (v1.12: new)
// tasks (1) → (∞) tasks (parent_task_id) (v1.12: task hierarchy)
// tasks (∞) → (1) task_templates (v1.12: new)
// tasks (1) ← (∞) knowledge_items (optional source tracking)
// tasks (1) → (∞) focus_environments (v1.9: new)
// tasks (1) → (∞) distraction_logs (v1.9: new)
// tasks (1) ← (∞) context_switches (from_task) (v1.9: new)
// tasks (1) → (∞) context_switches (to_task) (v1.9: new)
// tasks (1) → (∞) task_dependencies (task_id) (v1.12: new)
// tasks (1) ← (∞) task_dependencies (depends_on_task_id) (v1.12: new)
// tasks (1) → (∞) task_recurrence (v1.12: new)
// tasks (1) → (∞) task_instances (v1.12: new)
// tasks (1) → (∞) ai_task_predictions (v1.12: new)
// tasks (1) → (∞) ai_scheduling_suggestions (v1.12: new)
// tasks (1) → (∞) ai_dependency_suggestions (task_id) (v1.12: new)
// tasks (1) ← (∞) ai_dependency_suggestions (suggested_dependency_task_id) (v1.12: new)
// tasks (1) → (∞) time_entries (v1.12: new)
// tasks (1) → (∞) estimation_accuracy_logs (v1.12: new)

// Learning Path Relationships:
// learning_path_templates (1) → (∞) learning_milestone_templates
// learning_milestone_templates (1) → (∞) task_templates
// learning_paths (1) → (∞) learning_milestones
// learning_paths (1) → (∞) study_schedules (v1.11: new)
// learning_paths (∞) → (1) roadmaps (v1.12: new)
// learning_paths (∞) → (1) learning_path_templates (v1.12: new)
// learning_paths (1) → (∞) learning_path_dependencies (learning_path_id) (v1.13: new)
// learning_paths (1) ← (∞) learning_path_dependencies (depends_on_path_id) (v1.13: new)
// learning_paths (1) ← (∞) knowledge_items (optional)
// learning_milestones (1) ← (∞) tasks (optional)

// Roadmap System Relationships (v1.12):
// roadmaps (1) → (∞) roadmap_milestones
// roadmaps (1) → (∞) projects
// roadmaps (1) → (∞) tasks
// roadmaps (1) → (∞) learning_paths
// roadmaps (1) → (∞) ai_roadmap_generations
// roadmaps (1) → (∞) ai_dependency_suggestions
// roadmaps (1) → (∞) ai_optimization_history
// roadmaps (1) → (∞) time_entries
// roadmaps (1) → (∞) roadmap_critical_paths
// roadmaps (1) → (∞) burndown_snapshots
// roadmap_milestones (1) → (∞) roadmap_milestones (parent_milestone_id, self-referential hierarchy)
// roadmap_milestones (1) → (∞) tasks
// roadmap_milestones (1) → (∞) roadmap_milestone_dependencies (milestone_id) (v1.13: new)
// roadmap_milestones (1) ← (∞) roadmap_milestone_dependencies (depends_on_milestone_id) (v1.13: new)
// roadmap_templates (∞) → (1) users (created_by_user_id)

// Task Dependencies & Recurrence Relationships (v1.12):
// task_dependencies (1) → (∞) tasks (task_id)
// task_dependencies (1) → (∞) tasks (depends_on_task_id)
// task_recurrence (1) → (∞) tasks
// task_recurrence (1) → (∞) task_instances
// task_instances (1) → (∞) tasks

// Knowledge Repository Relationships:
// knowledge_categories (1) → (∞) knowledge_categories (self-referential hierarchy)
// knowledge_categories (1) → (∞) knowledge_items
// knowledge_items (∞) → (1) learning_paths (optional)
// knowledge_items (∞) → (1) tasks (optional source)
// knowledge_items (1) ← → (∞) knowledge_item_tags (via knowledge_item_tags)

// AI System Relationships (v1.4):
// users (1) → (∞) ai_summaries (new table for daily/weekly/monthly summaries)
// ai_suggestions tracks user acceptance via is_accepted field (renamed from is_read)

// Timetable System Relationships (v1.5):
// timetable_classes (1) → (∞) timetable_class_weekly_contents (weekly content for each class)
// timetable_classes (1) → (∞) timetable_studies (homework/review for each class)
// timetable_classes (∞) → (1) learning_paths (optional)
// timetable_studies (∞) → (1) tasks (optional link to task system)
// timetable_studies (∞) → (1) timetable_classes (optional)

// Cheat Code System Relationships (v1.7):
// cheat_code_languages (1) → (∞) cheat_code_sections (sections for each language)
// cheat_code_languages (1) → (∞) code_examples (denormalized language reference)
// cheat_code_languages (1) → (∞) exercises (exercises for each language)
// cheat_code_sections (1) → (∞) code_examples (examples in each section)
// exercises (1) → (∞) exercise_test_cases (test cases for each exercise)
// users (1) → (∞) user_exercise_submissions (submissions by users)
// users (1) → (∞) user_code_favorites (favorite code examples)
// users (1) → (∞) user_exercise_progress (progress tracking for exercises)
// exercises (1) → (∞) user_exercise_submissions
// exercises (1) → (∞) user_exercise_progress
// code_examples (1) → (∞) user_code_favorites

// Deep Work & Focus Enhancement Relationships (v1.9):
// focus_environments (1) ← (∞) tasks
// focus_environments (1) ← (∞) users
// focus_environments (∞) → (1) focus_sessions (optional)
// distraction_logs (1) ← (∞) tasks
// distraction_logs (1) ← (∞) users
// distraction_logs (∞) → (1) focus_sessions (optional)
// context_switches (1) ← (∞) users
// context_switches (∞) → (1) tasks (from_task, optional)
// context_switches (1) → (∞) tasks (to_task)


