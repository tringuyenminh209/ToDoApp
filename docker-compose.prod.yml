# Docker Compose for Production (2 vCPUs / 約4GB RAM 想定)
# 配分: MySQL 0.5 + Redis 0.2 + App 0.55 + Frontend 0.35 + Ollama 0.4 = 2.0 CPU
services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: todo-mysql-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE:-todo_app}
      MYSQL_USER: ${DB_USERNAME:-todo_user}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    networks:
      - todo-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 768M
        reservations:
          cpus: '0.2'
          memory: 384M

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: todo-redis-prod
    restart: always
    ports:
      - "6379:6379"
    networks:
      - todo-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Laravel Backend
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: todo-app-backend-prod
    restart: always
    working_dir: /var/www
    volumes:
      # - ./backend:/var/www
      - ./docker/nginx.conf:/etc/nginx/sites-available/default
      - ./docker/supervisord.conf:/etc/supervisor/conf.d/supervisord.conf
    ports:
      - "${APP_PORT:-8080}:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_KEY=${APP_KEY}
      - APP_URL=${APP_URL}
      - APP_TIMEZONE=${APP_TIMEZONE:-Asia/Tokyo}
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-todo_app}
      - DB_USERNAME=${DB_USERNAME:-root}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - QUEUE_CONNECTION=redis
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      # 同一 EC2: OLLAMA_BASE_URL=http://ollama:11434/v1 | 別サーバー: http://<IP>:11434/v1
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-dummy-key}
      - OPENAI_BASE_URL=${OLLAMA_BASE_URL}
      - OPENAI_MODEL=${OPENAI_MODEL:-qwen2.5:3b}
      # CORS: フロントのOrigin（ドメイン: https://todokizamu.me / IP: http://52.90.59.136:8088）
      - FRONTEND_URL=${FRONTEND_URL:-https://todokizamu.me}
      - FRONTEND_URL_WWW=${FRONTEND_URL_WWW}
      # リアルタイム: Reverb WebSocket（モバイル→Web フォーカス同期）
      - BROADCAST_CONNECTION=${BROADCAST_CONNECTION:-reverb}
      - REVERB_APP_ID=${REVERB_APP_ID:-todokizamu}
      - REVERB_APP_KEY=${REVERB_APP_KEY:-todokizamu-key}
      - REVERB_APP_SECRET=${REVERB_APP_SECRET:-todokizamu-secret}
      - REVERB_HOST=reverb
      - REVERB_PORT=8080
      - REVERB_SCHEME=http
    networks:
      - todo-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      reverb:
        condition: service_started
      # ollama は別サーバー化のため削除
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.55'
          memory: 896M
        reservations:
          cpus: '0.25'
          memory: 512M

  # Laravel Reverb（リアルタイム WebSocket: モバイル→Web フォーカス同期）
  # Nginx/ALB で wss://<APIドメイン> を reverb:8080 にプロキシすること
  reverb:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: todo-reverb-prod
    restart: always
    working_dir: /var/www
    ports:
      - "127.0.0.1:8081:8080"
    environment:
      - APP_ENV=production
      - REVERB_APP_ID=${REVERB_APP_ID:-todokizamu}
      - REVERB_APP_KEY=${REVERB_APP_KEY:-todokizamu-key}
      - REVERB_APP_SECRET=${REVERB_APP_SECRET:-todokizamu-secret}
      - REVERB_HOST=0.0.0.0
      - REVERB_PORT=8080
      - REVERB_SCHEME=http
    command: ["php", "artisan", "reverb:start", "--host=0.0.0.0", "--port=8080"]
    networks:
      - todo-network
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Next.js Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        # ビルド時に必須: API URL（ドメイン: https://api.todokizamu.me/api / IP: http://52.90.59.136:8080/api）
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        # リアルタイム: WebSocket（ドメイン時は .env.prod で NEXT_PUBLIC_REVERB_HOST=api.todokizamu.me, PORT=443, SCHEME=https）
        NEXT_PUBLIC_REVERB_APP_KEY: ${REVERB_APP_KEY:-todokizamu-key}
        NEXT_PUBLIC_REVERB_HOST: ${NEXT_PUBLIC_REVERB_HOST:-localhost}
        NEXT_PUBLIC_REVERB_PORT: ${NEXT_PUBLIC_REVERB_PORT:-8081}
        NEXT_PUBLIC_REVERB_SCHEME: ${NEXT_PUBLIC_REVERB_SCHEME:-http}
    container_name: todo-app-frontend-prod
    restart: always
    ports:
      - "${FRONTEND_PORT:-8088}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL:-http://app:80}
    depends_on:
      app:
        condition: service_healthy
    networks:
      - todo-network
    deploy:
      resources:
        limits:
          cpus: '0.35'
          memory: 512M
        reservations:
          cpus: '0.15'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Ollama (Local LLM) - gemma2:2b は約 1.9 GiB 必要。limit を 2.5G に設定
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: todo-ollama-prod
  #   restart: always
  #   ports:
  #     - "${OLLAMA_PORT:-11434}:11434"
  #   volumes:
  #     - ollama_data:/root/.ollama
  #   networks:
  #     - todo-network
  #   environment:
  #     - OLLAMA_GPU_MEMORY=0
  #     - OLLAMA_NUM_PARALLEL=1
  #     - OLLAMA_NUM_CTX=1024
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.4'
  #         memory: 2.5G
  #       reservations:
  #         cpus: '0.2'
  #         memory: 1G

volumes:
  mysql_data:
    driver: local
  # ollama_data: Ollama を別サーバーで運用するため削除

networks:
  todo-network:
    driver: bridge